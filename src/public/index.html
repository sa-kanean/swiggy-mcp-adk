<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Swiggy Cupid">
<meta name="theme-color" content="#FC8019">
<link rel="apple-touch-icon" href="/swiggy-logo.png">
<title>Swiggy Cupid - Valentine's Taste Match</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round">
<style>
:root {
  --primary: #FC8019;
  --primary-dark: #E86F00;
  --primary-light: #FFF4E6;
  --bg: #F2F2F2;
  --white: #FFFFFF;
  --text: #3D4152;
  --text-light: #7E808C;
  --text-lighter: #93959F;
  --border: #E9E9EB;
  --green: #60B246;
  --shadow: 0 1px 4px rgba(0,0,0,0.08);
  --shadow-sm: 0 1px 4px rgba(0,0,0,0.08);
  --radius: 16px;
  --radius-sm: 12px;
  --radius-input: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

html {
  height: 100%;
  overflow: hidden;
}

body {
  font-family: "Basis Grotesque Pro", "ProximaNova", -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100%;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-text-size-adjust: 100%;
}

/* ── Layout ── */
.app {
  max-width: 480px;
  margin: 0 auto;
  height: 100%;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  background: var(--white);
  box-shadow: 0 0 40px rgba(0,0,0,0.06);
  position: relative;
  overflow: hidden;
}

/* ── Screens ── */
.screen {
  display: none;
  flex-direction: column;
  flex: 1;
  min-height: 0;
}
.screen.active {
  display: flex;
}

/* ── Header ── */
.header {
  background: #FC8019;
  color: white;
  padding: 1rem 1.5rem;
  padding-top: calc(env(safe-area-inset-top, 0px) + 1rem);
  text-align: center;
  flex-shrink: 0;
}
.header h1 {
  font-size: 1.25rem;
  font-weight: 700;
  letter-spacing: -0.02em;
}
.header p {
  font-size: 0.8rem;
  opacity: 0.9;
  margin-top: 0.15rem;
}

/* ── Home Screen ── */
#screen-home { background: var(--white); }
#screen-home .header { display: none; }
.home-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 1.5rem;
  padding-top: calc(env(safe-area-inset-top, 0px) + 3rem);
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 1.5rem);
  text-align: center;
}
.hero-icon {
  margin-bottom: 1.25rem;
}
.hero-icon img {
  width: 96px;
  height: 96px;
  border-radius: 22px;
  box-shadow: 0 8px 32px rgba(252,128,25,0.25);
}
.home-brand {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--primary);
  margin-bottom: 0.75rem;
}
.home-content h2 {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--text);
  margin-bottom: 0.6rem;
  letter-spacing: -0.02em;
  line-height: 1.2;
}
.home-content .tagline {
  color: var(--text-light);
  font-size: 0.92rem;
  margin-bottom: 0;
  line-height: 1.6;
  max-width: 300px;
}
.home-actions {
  margin-top: auto;
  width: 100%;
  max-width: 340px;
}
.btn {
  display: block;
  width: 100%;
  max-width: 320px;
  padding: 0.9rem 1.5rem;
  min-height: 48px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
  text-align: center;
  -webkit-appearance: none;
  appearance: none;
}
.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: 0 4px 16px rgba(252,128,25,0.3);
}
.btn-primary:active { background: var(--primary-dark); transform: scale(0.98); }
.btn-outline {
  background: transparent;
  color: var(--primary);
  border: 2px solid var(--primary);
  margin-top: 0.75rem;
}
.btn-outline:active { background: var(--primary-light); }

.steps-mini {
  display: flex;
  gap: 0.5rem;
  margin: 1.75rem 0;
  flex-wrap: wrap;
  justify-content: center;
}
.step-chip {
  background: var(--primary-light);
  color: var(--primary);
  padding: 0.45rem 1rem;
  border-radius: 20px;
  font-size: 0.78rem;
  font-weight: 600;
  white-space: nowrap;
  letter-spacing: 0.01em;
}

/* ── Form Screen ── */
#screen-create, #screen-join { background: var(--white); }
#screen-create .header, #screen-join .header { display: none; }
.form-content {
  flex: 1;
  padding: 0 1.5rem;
  padding-top: calc(env(safe-area-inset-top, 0px) + 1.5rem);
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 1.5rem);
  display: flex;
  flex-direction: column;
  align-items: center;
}
/* ── Scrolling brand marquee ── */
.brand-marquee {
  width: 100%;
  overflow: hidden;
  margin-bottom: 1.25rem;
  display: flex;
  justify-content: center;
}
.brand-marquee-track {
  display: flex;
  gap: 1rem;
  align-items: center;
  animation: marqueeSlideIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  opacity: 0;
  transform: translateX(100px);
}
.brand-marquee-track .brand-icon {
  width: 60px;
  height: 60px;
  border-radius: 16px;
  flex-shrink: 0;
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}
.brand-marquee-track .brand-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 16px;
}
@keyframes marqueeSlideIn {
  0% { opacity: 0; transform: translateX(100px); }
  100% { opacity: 1; transform: translateX(0); }
}
.form-content h2 {
  font-size: 1.5rem;
  font-weight: 800;
  margin-bottom: 0.35rem;
  color: var(--text);
  letter-spacing: -0.02em;
  text-align: center;
}
.form-content .form-sub {
  color: var(--text-light);
  font-size: 0.88rem;
  margin-bottom: 2rem;
  line-height: 1.5;
  text-align: center;
}
.form-fields {
  width: 100%;
}
.form-group {
  margin-bottom: 1.1rem;
}
.form-group label {
  display: block;
  font-size: 0.8rem;
  font-weight: 700;
  margin-bottom: 0.4rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.04em;
  text-align: center;
}
.form-group input {
  width: 100%;
  padding: 0.85rem 1rem;
  min-height: 48px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-input);
  font-family: inherit;
  font-size: 16px; /* prevents iOS zoom on focus */
  color: var(--text);
  background: var(--white);
  text-align: center;
  transition: border-color 0.2s;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}
.form-group input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(252,128,25,0.12);
}
.form-group input::placeholder {
  color: var(--text-lighter);
}
.form-actions {
  margin-top: auto;
  padding-top: 1rem;
  width: 100%;
}
.form-actions .btn {
  max-width: 100%;
}
.back-link {
  display: block;
  text-align: center;
  margin-top: 0.75rem;
  padding: 0.5rem;
  min-height: 44px;
  line-height: 2;
  color: var(--text-light);
  font-size: 0.9rem;
  cursor: pointer;
  text-decoration: none;
}
.back-link:active { color: var(--primary); }

/* ── Waiting Screen ── */
#screen-waiting { background: var(--white); }
#screen-waiting .header { display: none; }
.waiting-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 1.5rem;
  padding-top: calc(env(safe-area-inset-top, 0px) + 3rem);
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 1.5rem);
  text-align: center;
}
.waiting-content .waiting-icon {
  width: 64px;
  height: 64px;
  background: var(--primary-light);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.75rem;
  margin-bottom: 1.25rem;
}
.waiting-content h2 {
  font-size: 1.5rem;
  font-weight: 800;
  color: var(--text);
  letter-spacing: -0.02em;
  margin-bottom: 0.3rem;
}
.waiting-content .waiting-sub {
  color: var(--text-light);
  font-size: 0.88rem;
  margin-bottom: 1.5rem;
}
.room-code {
  background: var(--bg);
  border: 2px dashed var(--primary);
  border-radius: var(--radius);
  padding: 1.25rem 2.5rem;
  margin: 0;
}
.room-code .label {
  font-size: 0.7rem;
  color: var(--text-lighter);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-weight: 600;
}
.room-code .code {
  font-size: 2.25rem;
  font-weight: 800;
  color: var(--primary);
  letter-spacing: 0.12em;
  font-family: "SF Mono", "Menlo", monospace;
  margin-top: 0.15rem;
}
.copy-btn {
  background: var(--primary-light);
  border: none;
  color: var(--primary);
  font-family: inherit;
  font-size: 0.85rem;
  cursor: pointer;
  padding: 0.5rem 1.25rem;
  min-height: 44px;
  border-radius: 20px;
  font-weight: 600;
  margin-top: 1rem;
}
.copy-btn:active { opacity: 0.7; }
.pulse {
  display: inline-block;
  width: 10px; height: 10px;
  background: var(--primary);
  border-radius: 50%;
  margin-right: 0.5rem;
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.3); }
}
.waiting-status {
  font-size: 0.88rem;
  color: var(--text-light);
  margin-top: 1.75rem;
  display: flex;
  align-items: center;
}
.waiting-actions {
  margin-top: auto;
  width: 100%;
  max-width: 280px;
}

/* ── Chat Screen ── */
.chat-header {
  background: #FC8019;
  color: white;
  padding: 0.9rem 1.25rem;
  padding-top: calc(env(safe-area-inset-top, 0px) + 0.9rem);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex-shrink: 0;
}
.chat-header .room-tag {
  background: rgba(255,255,255,0.2);
  padding: 0.2rem 0.6rem;
  border-radius: 8px;
  font-size: 0.75rem;
  margin-left: auto;
  font-family: monospace;
}
.chat-header h2 { font-size: 1.1rem; }

.status-bar {
  display: flex;
  gap: 0.75rem;
  padding: 0.6rem 1.25rem;
  background: var(--primary-light);
  font-size: 0.78rem;
  flex-shrink: 0;
  overflow-x: auto;
}
.status-pill {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  white-space: nowrap;
}
.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--border);
  flex-shrink: 0;
}
.status-dot.done { background: var(--green); }
.status-dot.active { background: var(--primary); animation: pulse 1.5s ease-in-out infinite; }

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  min-height: 0;
  scroll-behavior: smooth;
  background: var(--bg);
  -webkit-overflow-scrolling: touch;
  overscroll-behavior-y: contain;
}

.msg {
  max-width: 85%;
  padding: 0.75rem 1rem;
  border-radius: 18px;
  font-size: 0.92rem;
  line-height: 1.5;
  word-wrap: break-word;
  animation: msgIn 0.25s ease-out;
}
@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.msg.agent {
  background: var(--white);
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.msg.user {
  background: var(--primary);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.msg.system {
  align-self: center;
  background: var(--primary-light);
  color: var(--primary);
  font-size: 0.82rem;
  font-weight: 500;
  padding: 0.5rem 1rem;
  border-radius: 20px;
}
.msg .sender {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  margin-bottom: 0.2rem;
  opacity: 0.7;
}
.typing-indicator {
  align-self: flex-start;
  padding: 0.75rem 1rem;
  background: var(--white);
  border-radius: 18px;
  display: none;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  margin: 0 1rem 0.5rem;
}
.typing-indicator.visible { display: flex; gap: 4px; align-items: center; }
.typing-dot {
  width: 7px; height: 7px;
  background: var(--text-lighter);
  border-radius: 50%;
  animation: typingBounce 1.4s ease-in-out infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-6px); }
}

.chat-input {
  display: flex;
  gap: 0.5rem;
  padding: 0.6rem 1rem;
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 0.6rem);
  border-top: 1px solid var(--border);
  background: var(--white);
  flex-shrink: 0;
}
.chat-input input {
  flex: 1;
  padding: 0.65rem 1rem;
  min-height: 44px;
  border: 1.5px solid var(--border);
  border-radius: 24px;
  font-family: inherit;
  font-size: 16px; /* prevents iOS zoom */
  color: var(--text);
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
  appearance: none;
}
.chat-input input:focus { border-color: var(--primary); }
.chat-input input::placeholder { color: var(--text-lighter); }
.chat-input button {
  width: 44px; height: 44px;
  border: none;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: background 0.15s;
  -webkit-appearance: none;
}
.chat-input button:active { background: var(--primary-dark); }
.chat-input button:disabled { background: var(--border); cursor: not-allowed; }
.send-icon {
  width: 20px; height: 20px;
  fill: white;
}

/* ── Match Result Card ── */
.match-card {
  background: var(--white);
  border: none;
  border-radius: var(--radius);
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  padding: 1.25rem;
  margin: 0.5rem 0;
  text-align: center;
  max-width: 90%;
  align-self: center;
  animation: msgIn 0.4s ease-out;
}
.match-card .score {
  font-size: 3rem;
  font-weight: 800;
  color: var(--primary);
}
.match-card .score-label {
  font-size: 0.8rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.match-card .recs {
  margin-top: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.rec-btn {
  padding: 0.7rem 1rem;
  min-height: 44px;
  border: 2px solid var(--primary);
  background: var(--white);
  color: var(--primary);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  -webkit-appearance: none;
}
.rec-btn:active {
  background: var(--primary);
  color: white;
}

/* ── iOS standalone mode ── */
@media (display-mode: standalone) {
  .header, .chat-header {
    padding-top: calc(env(safe-area-inset-top, 0px) + 0.75rem);
  }
}

/* ── Desktop ── */
@media (min-width: 481px) {
  body { background: var(--bg); }
  .app { border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
}

/* ── Mobile-first: full-bleed on phones ── */
@media (max-width: 480px) {
  .app {
    max-width: 100%;
    box-shadow: none;
  }
}
</style>
</head>
<body>
<div class="app">

  <!-- ═══ HOME SCREEN ═══ -->
  <div id="screen-home" class="screen active">
    <div class="header">
      <h1>Swiggy Cupid</h1>
      <p>Valentine's Couple Taste Match</p>
    </div>
    <div class="home-content">
      <div class="hero-icon"><img src="/swiggy-logo.png" alt="Swiggy"></div>
      <div class="home-brand">Swiggy Cupid</div>
      <h2>Find Your Food<br>Soulmate</h2>
      <p class="tagline">Take a fun quiz with your partner and discover how compatible your taste buds really are!</p>
      <div class="steps-mini">
        <span class="step-chip">1. Quiz</span>
        <span class="step-chip">2. Match</span>
        <span class="step-chip">3. Eat!</span>
      </div>
      <div class="home-actions">
        <button class="btn btn-primary" onclick="showScreen('create')">Start a Room</button>
        <button class="btn btn-outline" onclick="showScreen('join')">Join a Room</button>
      </div>
    </div>
  </div>

  <!-- ═══ CREATE ROOM SCREEN ═══ -->
  <div id="screen-create" class="screen">
    <div class="header">
      <h1>Create a Room</h1>
      <p>You'll get a code to share with your partner</p>
    </div>
    <div class="form-content">
      <a class="back-link" onclick="showScreen('home')" style="align-self:flex-start;margin:0 0 0.75rem -0.25rem;line-height:1;min-height:auto;padding:0.25rem 0.5rem">&#8592; Back</a>
      <div class="brand-marquee">
        <div class="brand-marquee-track">
          <div class="brand-icon"><img src="/swiggy-logo.png" alt="Swiggy"></div>
          <div class="brand-icon"><img src="/instamart-logo.png" alt="Instamart"></div>
          <div class="brand-icon"><img src="/dineout-logo.png" alt="Dineout"></div>
        </div>
      </div>
      <h2>Create a Room</h2>
      <p class="form-sub">You'll get a code to share with your partner</p>
      <div class="form-fields">
        <div class="form-group">
          <label>Your Name</label>
          <input id="create-name" type="text" placeholder="e.g. Alice" autocomplete="given-name">
        </div>
        <div class="form-group">
          <label>Your Phone</label>
          <input id="create-phone" type="tel" placeholder="e.g. 9876543210" autocomplete="tel">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="createRoom()">Create Room</button>
      </div>
    </div>
  </div>

  <!-- ═══ JOIN ROOM SCREEN ═══ -->
  <div id="screen-join" class="screen">
    <div class="header">
      <h1>Join a Room</h1>
      <p>Enter the code your partner shared</p>
    </div>
    <div class="form-content">
      <a class="back-link" onclick="showScreen('home')" style="align-self:flex-start;margin:0 0 0.75rem -0.25rem;line-height:1;min-height:auto;padding:0.25rem 0.5rem">&#8592; Back</a>
      <div class="brand-marquee">
        <div class="brand-marquee-track">
          <div class="brand-icon"><img src="/swiggy-logo.png" alt="Swiggy"></div>
          <div class="brand-icon"><img src="/instamart-logo.png" alt="Instamart"></div>
          <div class="brand-icon"><img src="/dineout-logo.png" alt="Dineout"></div>
        </div>
      </div>
      <h2>Join a Room</h2>
      <p class="form-sub">Enter the code your partner shared</p>
      <div class="form-fields">
        <div class="form-group">
          <label>Room Code</label>
          <input id="join-code" type="text" placeholder="e.g. A1B2C3D4" autocomplete="off" style="text-transform:uppercase;letter-spacing:0.1em;font-family:'SF Mono','Menlo',monospace;font-size:16px;text-align:center">
        </div>
        <div class="form-group">
          <label>Your Name</label>
          <input id="join-name" type="text" placeholder="e.g. Bob" autocomplete="given-name">
        </div>
        <div class="form-group">
          <label>Your Phone</label>
          <input id="join-phone" type="tel" placeholder="e.g. 9123456780" autocomplete="tel">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="joinRoom()">Join Room</button>
      </div>
    </div>
  </div>

  <!-- ═══ WAITING SCREEN ═══ -->
  <div id="screen-waiting" class="screen">
    <div class="header">
      <h1>Room Created!</h1>
      <p>Share this code with your partner</p>
    </div>
    <div class="waiting-content">
      <div class="waiting-icon">&#127881;</div>
      <h2>Room Created!</h2>
      <p class="waiting-sub">Share this code with your partner</p>
      <div class="room-code">
        <div class="label">Room Code</div>
        <div class="code" id="waiting-code">---</div>
      </div>
      <button class="copy-btn" onclick="copyRoomCode()"><span class="material-icons-round" style="font-size:18px;vertical-align:middle;margin-right:4px">content_copy</span>Copy Code</button>
      <div class="waiting-status">
        <span class="pulse"></span>
        Waiting for your partner to join...
      </div>
      <div class="waiting-actions">
        <button class="btn btn-primary" onclick="enterChat()">Enter Chat</button>
      </div>
    </div>
  </div>

  <!-- ═══ CHAT SCREEN ═══ -->
  <div id="screen-chat" class="screen">
    <div class="chat-header">
      <img src="/swiggy-logo.png" alt="Swiggy" style="width:32px;height:32px;border-radius:8px">
      <h2>Swiggy Cupid</h2>
      <span class="room-tag" id="chat-room-tag">---</span>
    </div>
    <div class="status-bar" id="status-bar">
      <div class="status-pill"><span class="status-dot" id="status-p1"></span><span id="status-p1-text">Partner 1</span></div>
      <div class="status-pill"><span class="status-dot" id="status-p2"></span><span id="status-p2-text">Partner 2</span></div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing-indicator" id="typing">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    <div class="chat-input">
      <input id="chat-text" type="text" placeholder="Type a message..." autocomplete="off"
        onkeydown="if(event.key==='Enter')sendMessage()">
      <button onclick="sendMessage()" id="send-btn">
        <svg class="send-icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

</div>

<script>
// ── State ──
let state = {
  userId: 'user_' + Math.random().toString(36).slice(2, 8),
  roomId: null,
  name: null,
  ws: null,
};

// ── Navigation ──
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

// ── Create Room ──
async function createRoom() {
  const name = document.getElementById('create-name').value.trim();
  const phone = document.getElementById('create-phone').value.trim();
  if (!name || !phone) return alert('Please fill in all fields');

  try {
    const res = await fetch('/api/rooms', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId, name, phone }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    state.roomId = data.roomId;
    state.name = name;

    document.getElementById('waiting-code').textContent = data.roomId.toUpperCase();
    showScreen('waiting');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ── Join Room ──
async function joinRoom() {
  const code = document.getElementById('join-code').value.trim().toLowerCase();
  const name = document.getElementById('join-name').value.trim();
  const phone = document.getElementById('join-phone').value.trim();
  if (!code || !name || !phone) return alert('Please fill in all fields');

  try {
    const res = await fetch(`/api/rooms/${code}/join`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: state.userId, name, phone }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    state.roomId = data.roomId;
    state.name = name;

    enterChat();
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// ── Copy Room Code ──
function copyRoomCode() {
  const code = state.roomId || '';
  navigator.clipboard.writeText(code).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Code', 1500);
  });
}

// ── Enter Chat ──
function enterChat() {
  document.getElementById('chat-room-tag').textContent = state.roomId.toUpperCase();
  showScreen('chat');
  connectWebSocket();
}

// ── WebSocket ──
function connectWebSocket() {
  if (state.ws) state.ws.close();

  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = `${protocol}//${location.host}/ws/${state.roomId}?userId=${state.userId}`;
  const ws = new WebSocket(wsUrl);
  state.ws = ws;

  ws.onopen = () => {
    addSystemMessage('Connected! Say hi to start the quiz.');
    // Send an initial greeting to trigger the agent
    ws.send(JSON.stringify({ type: 'message', text: `Hi! I'm ${state.name}, ready for the Valentine's Taste Match!` }));
    showTyping(true);
  };

  ws.onmessage = (evt) => {
    const data = JSON.parse(evt.data);

    switch (data.type) {
      case 'agent_message':
        showTyping(false);
        addAgentMessage(data.text);
        break;

      case 'partner_joined':
        addSystemMessage(`${data.partner.name} joined the room!`);
        break;

      case 'quiz_update':
        updateQuizStatus(data.status);
        break;

      case 'match_result':
        showMatchResult(data);
        break;

      case 'action_chosen':
        handleActionChosen(data);
        break;

      case 'swiggy_auth_required':
        handleSwiggyAuthRequired(data);
        break;

      case 'swiggy_auth_complete':
        handleSwiggyAuthComplete();
        break;

      case 'error':
        addSystemMessage('Error: ' + data.error);
        showTyping(false);
        break;
    }
  };

  ws.onclose = () => {
    addSystemMessage('Disconnected. Refresh to reconnect.');
  };

  ws.onerror = () => {
    addSystemMessage('Connection error. Please try again.');
  };
}

// ── Chat Messages ──
function addMessage(html, cls) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ' + cls;
  div.innerHTML = html;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function addAgentMessage(text) {
  // Simple markdown-ish: **bold**, newlines
  let html = escapeHtml(text)
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
  addMessage('<div class="sender">Swiggy Cupid</div>' + html, 'agent');
}

function addUserMessage(text) {
  addMessage(escapeHtml(text), 'user');
}

function addSystemMessage(text) {
  addMessage(escapeHtml(text), 'system');
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function showTyping(visible) {
  document.getElementById('typing').classList.toggle('visible', visible);
  if (visible) {
    const container = document.getElementById('messages');
    container.scrollTop = container.scrollHeight;
  }
}

// ── Send Message ──
function sendMessage() {
  const input = document.getElementById('chat-text');
  const text = input.value.trim();
  if (!text || !state.ws || state.ws.readyState !== WebSocket.OPEN) return;

  addUserMessage(text);
  state.ws.send(JSON.stringify({ type: 'message', text }));
  input.value = '';
  showTyping(true);
}

// ── Quiz Status ──
function updateQuizStatus(status) {
  const p1Dot = document.getElementById('status-p1');
  const p2Dot = document.getElementById('status-p2');
  const p1Text = document.getElementById('status-p1-text');
  const p2Text = document.getElementById('status-p2-text');

  p1Dot.className = 'status-dot' + (status.partner1Complete ? ' done' : ' active');
  p1Text.textContent = status.partner1Complete ? 'P1 Done' : 'P1 In Progress';
  p2Dot.className = 'status-dot' + (status.partner2Complete ? ' done' : status.partner1Complete ? ' active' : '');
  p2Text.textContent = status.partner2Complete ? 'P2 Done' : 'P2 Waiting';
}

// ── Match Result ──
function showMatchResult(data) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'match-card';
  div.innerHTML = `
    <div class="score-label">Taste Compatibility</div>
    <div class="score">${data.compatibility}%</div>
    <div class="recs">
      ${(data.recommendations || []).map(r => `
        <button class="rec-btn" onclick="chooseOption('${r.type}')">${r.title}</button>
      `).join('')}
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function chooseOption(type) {
  const labels = { delivery: "Let's order in!", dineout: "Let's dine out!", cook: "Let's cook together!" };
  const text = labels[type] || "Let's go with " + type;
  const input = document.getElementById('chat-text');
  input.value = text;
  sendMessage();
}

function handleActionChosen(data) {
  const actionLabels = { delivery: 'Order In', dineout: 'Dine Out', cook: 'Cook Together' };
  const label = actionLabels[data.action] || data.action;
  const isMine = data.chosenBy === state.name;
  const msg = isMine
    ? `You chose ${label}! Let's find the perfect meal for you two.`
    : `${data.chosenBy} chose ${label}! Let's find the perfect meal for you two.`;
  addSystemMessage(msg);

  // Disable and hide all recommendation buttons
  document.querySelectorAll('.rec-btn').forEach(btn => {
    btn.disabled = true;
    btn.style.opacity = '0.4';
    btn.style.pointerEvents = 'none';
  });
}

// ── Swiggy OAuth Flow ──
function handleSwiggyAuthRequired(data) {
  showTyping(false);
  // Add a system message with a "Connect Swiggy" button
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg system';
  div.style.maxWidth = '90%';
  div.innerHTML = `
    <div style="text-align:center">
      <p style="margin-bottom:0.75rem;font-weight:600">Connect your Swiggy account to continue</p>
      <button onclick="openSwiggyAuth('${escapeHtml(data.authUrl)}')"
        style="background:var(--primary);color:white;border:none;border-radius:12px;
               padding:0.7rem 1.5rem;font-size:0.95rem;font-weight:600;cursor:pointer;
               box-shadow:0 4px 16px rgba(252,128,25,0.3);transition:all 0.2s"
        onmouseover="this.style.background='var(--primary-dark)'"
        onmouseout="this.style.background='var(--primary)'"
        id="swiggy-auth-btn">
        Connect Swiggy
      </button>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function openSwiggyAuth(authUrl) {
  // Open in a popup window
  const popup = window.open(authUrl, 'swiggy_auth', 'width=500,height=700,scrollbars=yes');

  // Listen for the completion message from the popup
  window.addEventListener('message', function onMsg(evt) {
    if (evt.data && evt.data.type === 'swiggy_auth_complete') {
      window.removeEventListener('message', onMsg);
      // The WebSocket will also receive the swiggy_auth_complete event
    }
  });

  // Update the button to show waiting state
  const btn = document.getElementById('swiggy-auth-btn');
  if (btn) {
    btn.textContent = 'Waiting for login...';
    btn.disabled = true;
    btn.style.opacity = '0.7';
  }
}

function handleSwiggyAuthComplete() {
  showTyping(false);
  addSystemMessage('Connected to Swiggy! Starting your food experience...');
  showTyping(true);

  // Remove or disable the auth button if still present
  const btn = document.getElementById('swiggy-auth-btn');
  if (btn) {
    btn.textContent = 'Connected!';
    btn.disabled = true;
    btn.style.background = '#60B246';
    btn.style.opacity = '1';
  }
}

// ── Auto-fill room code from URL hash ──
if (location.hash.startsWith('#room=')) {
  const code = location.hash.slice(6);
  document.getElementById('join-code').value = code;
  showScreen('join');
}
</script>
</body>
</html>
